<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC
    "-//W3C//DTD XHTML 1.1 plus MathML 2.0 plus SVG 1.1//EN"
    "http://www.w3.org/2002/04/xhtml-math-svg/xhtml-math-svg.dtd">
<html xml:lang='en' xmlns:svg='http://www.w3.org/2000/svg' xmlns='http://www.w3.org/1999/xhtml'>
<head><meta content='application/xhtml+xml;charset=utf-8' http-equiv='Content-type' /><title></title></head>
<body><hr />
<p>title: The API for Google&#8217;s most valuable resource sucks date: 15/08/2012 tags: notable</p>

<blockquote>
<p>Disclosure: I recently worked for Google for about a year. It was alright.</p>
</blockquote>

<p>Recently, Vic Gundotra of Google+ fame made a bold statement. He <a href='https://plus.google.com/107117483540235115863/posts/EstNjiL2uon'>proclaimed</a> that the lack of write API access to Google+ is born not out of lack of foresight, planning, or even bandwidth, but out of trepidation, caution, and the desire to do right by developers.</p>

<p>This is raw, barely-refined bullshit~ and I regret not being able to respond to the thread with a pithier snarky comment. The truth is simpler: Google is full-stop terrible at APIs.</p>

<p><img alt='Vic Gundotra' src='http://farm9.staticflickr.com/8440/7784924826_01c136c801.jpg' /></p>

<h4 id='dont_look_at_me_it_says_so_right_there'>Don&#8217;t look at me, it says so right there</h4>

<p>As a case study, let&#8217;s examine what I had to do in order to use the most powerful collection of user-generated content that Google makes available to developers: a user&#8217;s <a href='https://developers.google.com/google-apps/contacts/v3/'>email contact list</a>. People who work for consumer- facing web companies probably know how deeply important having a user&#8217;s email address is for marketing. Despite being invented before I was born, email has yet to be outmoded as the most effective way to push content to users on demand.</p>

<h3 id='the_feature'>The feature</h3>

<p>Recently here at <a href='https://www.everlane.com/about'>Everlane</a>, we thought it might be a good idea to have a button a user could hit to view a list of their Gmail contacts with portraits, select some of them, and then have us send those users an invitation email. Simple, obvious stuff to want to do, right?</p>

<p><img alt='import screen 1' src='http://farm9.staticflickr.com/8293/7784680274_968248f0fb_z.jpg' /></p>

<p><img alt='import screen 2' src='http://farm9.staticflickr.com/8437/7785016330_cf1cf02710_z.jpg' /></p>

<h4 id='what_we_want_to_implement'>What we want to implement</h4>

<p>Well, let&#8217;s hit the <a href='https://developers.google.com/google-apps/contacts/v3/index#getting_started'>getting started page</a> of the contacts API documentation. Reading closely seems to reveal that there might already be a library for doing what we want, which is really nothing more than getting a bunch of names, faces, and emails. Those geniuses at Google <em>have</em> to have something already made for this, right? We head over to the <a href='https://developers.google.com/google-apps/tasks/downloads'>libraries and samples page</a>. Cool, a <a href='http://code.google.com/p/google-api-javascript-client/'>Javascript library</a>! This could be easy! <em>Nope</em>, they seem to support every Google API but Contacts. The Google+ read API doesn&#8217;t seem to have a good way to grab emails, either.</p>

<p>That&#8217;s fine &#8211; we&#8217;re pretty decent engineers and can call the Contacts API on our own. We register our application with the <a href='https://code.google.com/apis/console#access'>API Console</a> and start reading about OAuth. Google provides a <a href='https://developers.google.com/accounts/docs/OAuth2#scenarios'>few authorization schemes</a>. We probably want the one titled &#8221;<a href='https://developers.google.com/accounts/docs/OAuth2UserAgent'>Client-side Applications</a>&#8221;, which saves us the complexity of an application server having to be aware of any sensitive information.</p>

<h3 id='api_woes'>API woes</h3>

<p>Now we can finally ask the Contacts API for a list of contacts! Easy enough, right? We&#8217;ll just do a JSONP request to get around the cross-domain restrictions.</p>
<pre><code class='javascript'>var authParams = { access_token: ..., token_type: ... }; // from Google oAuth

$.ajax({
  url: 'https://www.google.com/m8/feeds/contacts/default/full',
  dataType: 'jsonp',
  data: authParams,
  success: function(data) { console.log(data); }
});
</code></pre>
<p>What does this give us? To our slow and creeping horror, we get back something like this for every contact:</p>

<pre><code>&lt;entry gd:etag=&#39;&amp;quot;QHc_fDVSLit7I2A9WhJXFUkDQQ0.&amp;quot;&#39;&gt;
  &lt;id&gt;http://www.google.com/m8/feeds/contacts/your%40gmail.com/base/13659b580fe5686d&lt;/id&gt;
  &lt;updated&gt;2012-08-09T22:01:31.944Z&lt;/updated&gt;
  &lt;app:edited xmlns:app=&#39;http://www.w3.org/2007/app&#39;&gt;2012-08-09T22:01:31.944Z&lt;/app:edited&gt;
  &lt;category scheme=&#39;http://schemas.google.com/g/2005#kind&#39; term=&#39;http://schemas.google.com/contact/2008#contact&#39;/&gt;
  &lt;title&gt;Diane Duane&lt;/title&gt;
  &lt;link
    rel=&#39;http://schemas.google.com/contacts/2008/rel#photo&#39;
    type=&#39;image/*&#39;
    href=&#39;https://www.google.com/m8/feeds/photos/media/your%40gmail.com/13659b580fe5686d?v=3.0&#39;
    gd:etag=&#39;&amp;quot;UWlBIlclWit7I2A9AFQKRg9YFXoHL0oQSQA.&amp;quot;&#39;/&gt;
  &lt;link
    rel=&#39;self&#39;
    type=&#39;application/atom+xml&#39;
    href=&#39;https://www.google.com/m8/feeds/contacts/your%40gmail.com/full/13659b580fe5686d?v=3.0&#39;/&gt;
  &lt;link
    rel=&#39;edit&#39;
    type=&#39;application/atom+xml&#39;
    href=&#39;https://www.google.com/m8/feeds/contacts/your%40gmail.com/full/13659b580fe5686d?v=3.0&#39;/&gt;
  &lt;gd:name&gt;
    &lt;gd:fullName&gt;Diane Duane&lt;/gd:fullName&gt;
    &lt;gd:givenName&gt;Diane&lt;/gd:givenName&gt;
    &lt;gd:familyName&gt;Duane&lt;/gd:familyName&gt;
  &lt;/gd:name&gt;
  &lt;gd:email
    rel=&#39;http://schemas.google.com/g/2005#other&#39;
    address=&#39;diane.duane@gmail.com&#39;
    primary=&#39;true&#39;/&gt;
&lt;/entry&gt;</code></pre>

<p>You take several deep breaths. You ignore the fact that you are fetching roughly 1kb of data per contact (out of potentially thousands) to get a name, an email, and the URL of an image. &#8220;Okay&#8221;, you think to yourself, &#8220;this is still salvageable. I can parse XML on the client. In fact, jQuery can probably do it for me.&#8221; You take a quick stab at grabbing names and emails.</p>

<pre><code>success: function(data) {
  var xml = $.parseXML(data);
  $(xml).find(&#39;entry&#39;).each(function() {
    var entry = $(this);
    var name  = entry.find(&#39;title&#39;).text();
    var email = entry.find(&#39;email&#39;).attr(&#39;address&#39;);
  });
}</code></pre>

<p>A quick browser test shows that this only appears to work in Chrome. A bit more digging turns up, to your chagrin, that jQuery has trouble finding namespaced elements like &#8221;<a href='gd:email'>gd:email</a>&#8221; in XML documents on different browsers. You Google around and find a fix:</p>

<pre><code>var email = entry.find(&#39;email, gd\\:email&#39;).attr(&#39;address&#39;);</code></pre>

<p>For now, you ignore <a href='http://www.steveworkman.com/html5-2/javascript/2011/improving-javascript-xml-node-finding-performance-by-2000/'>how inefficient this is</a>, hoping merely to reach functionality. It works! Now you want to add images. It looks like one of the link elements under \<pre class='markdown-html-error' style='border: solid 3px red; background-color: pink'>REXML could not parse this XML/HTML: 
&lt;entry\&gt; appears to point to an image for that contact. You
fiddle around on the console:</pre></p>
<pre><code class='javascript'>entry.find('link[type="image/*"]').attr('href')
// => https://www.google.com/m8/feeds/photos/media/your%40gmail.com/13659b580fe5686d?v=3.0
</code></pre>
<p>Attempting to load this in your browser gives you a 401. Taking a look a the <a href='https://developers.google.com/google-apps/contacts/v3/index#retrieving_a_contacts_photo'>photo management section of the docs</a> seems to suggest you need to additionally apply auth credentials to this url. You amend your code:</p>

<pre><code>var href = entry.find(&#39;link[type=&quot;image/*&quot;]&#39;).attr(&#39;href&#39;);
var imageUrl = href + &#39;&amp;&#39; + $.param(authParams);</code></pre>

<p>This seems to produce a real photo in your browser. Success! Let&#8217;s extrapolate:</p>

<pre><code>$(xml).find(&#39;entry&#39;).each(function() {
  var entry = $(this);
  var href = entry.find(&#39;link[type=&quot;image/*&quot;]&#39;).attr(&#39;href&#39;);
  var imageUrl = href + &#39;&amp;&#39; + $.param(authParams);
  $(&#39;body&#39;).append(&#39;&lt;img src=&quot;&#39; + imageUrl + &#39;&quot; /&gt;&#39;);
});</code></pre>

<h3 id='image_contortions'>Image contortions</h3>

<p>Unfortunately, only a few images load. What&#8217;s going on? You squint at the docs more closely.</p>

<blockquote>
<p>Note: If a contact does not have a photo, then the photo link element has no gd:etag attribute.</p>
</blockquote>

<p>Great, so some image links have a magic attribute on them that says they&#8217;re real images. You wonder why Google even bothers returning image links for photos that don&#8217;t exist. You try something like the following:</p>
<pre><code class='javascript'>.find('link[type="image/*"][gd\\:etag]') // or even
.find('link[type="image/*"][gd:etag]') // nope? how about
.find('link[type="image/*"][etag]')
</code></pre>
<p>But no, jQuery can&#8217;t deal with namespaced attribute selection, at all, so you arrive at:</p>
<pre class='markdown-html-error' style='border: solid 3px red; background-color: pink'>REXML could not parse this XML/HTML: 
&lt;pre&gt;&lt;code class=&quot;javascript&quot;&gt;var link = entry.find(&apos;link[type=&quot;image/*&quot;]&apos;);
if (entry.attr(&apos;gd:etag&apos;)) {
  var imageUrl = link.attr(&apos;href&apos;) + &apos;&amp;&apos; + $.param(authParams);
  $(&apos;body&apos;).append(&apos;&amp;lt;img src=&quot;&apos; + imageUrl + &apos;&quot; /&amp;gt;&apos;);
}
&lt;/code&gt;&lt;/pre&gt;</pre>
<p>This time, a few more photos load, but then they stop coming. The console shows a few successful image loads, but most of the requests for images returned with <strong>503 (Service Unavailable)</strong> errors. You realize, after an hour or so, that each image load is being counted as an API call against you, and that there must be some rate limiting in place.</p>

<p>Naturally, this fact is completely undocumented. Playing around with the code, you find that Google doesn&#8217;t like it if you have more than one in-flight API request at a time. You come up with essentially the opposite of an image preloader to stagger image loading:</p>

<pre><code>var imageUrls = [&#39;https://...&#39;, ...];
function staggerImages(index) {
  if (index == imageUrls.length) return;
  var img = new Image();
  img.onload = function() {
    setTimeout(function() {
      // Load the next image 100ms after this one finishes loading
      populateImages(index + 1);
    }, 100);
  };
  img.src = imageUrls[index];
  $(&#39;body&#39;).append(img);
}
populateImages(0);</code></pre>

<p>Whew, that was fun, right? At this point it seems like a good idea to try to sort contacts by some sort of relevance metric. Unfortunately, the Contacts API doesn&#8217;t support this at all. Oh well. You give up, having reached something approximating your original goals.</p>

<h3 id='what_have_we_learned'>What have we learned?</h3>

<ul>
<li>Google doesn&#8217;t get JSON.</li>

<li>Google can&#8217;t design clean APIs or document them well.</li>

<li>Despite their browser-first mantra, Google doesn&#8217;t put out first-party Javascript libraries for the browser.</li>

<li>Vic Gundotra is <em>soooooo</em> lying.</li>
</ul>

<p>Developers waiting for Google+ to deliver on its full, API-wonderland potential: you should probably just give up. What are the odds that this whole time, they&#8217;ve been cooking up the perfect write API, replete with features, libraries, and documentation? I&#8217;m betting that they&#8217;re doing exactly what I did when I worked for Google: <em>absolutely nothing of importance</em>.</p>

<blockquote>
<p>Lastly, we&#8217;re always on the lookout for talented developers who are interested</p>
</blockquote>

<p>in the fashion space here at <a href='https://www.everlane.com/about'>Everlane</a>. You don&#8217;t need to own more than one pair of shoes. My love of fashion is born of William Gibson novels and is almost entirely academic. If you&#8217;re interested, check out our <a href='https://www.everlane.com/jobs'>jobs page</a> or send me an email at <a href='mailto:me@vincentwoo.com'>me@vincentwoo.com</a>.</p>

<blockquote>
<p>P.S. Yes, I am aware there is an older <a href='http://code.google.com/p/gdata-javascript-client/'>gdata library</a> that can</p>
</blockquote>

<p>potentially handle contacts. I might have used it if it wasn&#8217;t deprecated or Google had made any mention of it whatsoever on their Contacts API page.</p>
</body></html>
